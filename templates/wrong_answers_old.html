<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š æˆ‘çš„é”™é¢˜æœ¬ - æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-wrapper">
        <div class="user-info-bar">
            <div>
                {% if username %}
                    <span>æ¬¢è¿æ‚¨, <strong>{{ username }}</strong>! ğŸ“š</span>
                {% else %}
                    <span>æ¬¢è¿, è®¿å®¢! è¯·å…ˆ<a href="{{ url_for('login_page') }}" style="color: #60a5fa; text-decoration: underline;">ç™»å½•</a> ğŸ”</span>
                {% endif %}
            </div>
            <div>
                {% if username %}
                    <button id="logoutBtnGlobal" class="btn-danger">é€€å‡ºç™»å½•</button> 
                {% endif %}
            </div>
        </div>
        
        <div class="container-box wrong-answers-container">
            <h1>ğŸ“š æˆ‘çš„é”™é¢˜æœ¬</h1>
            <p class="subtitle">æ™ºèƒ½é”™é¢˜ç®¡ç†ï¼ŒåŠ©åŠ›é«˜æ•ˆå­¦ä¹ </p>
            
            <!-- å¯¼èˆªæ  -->
            <div class="navigation-bar">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <a href="{{ url_for('quiz_page_actual') }}" class="btn btn-outline">
                        ğŸ¯ è¿”å›ç»ƒä¹ 
                    </a>
                    {% if wrong_answers and wrong_answers|length > 0 %}
                    <a href="{{ url_for('retry_wrong_questions') }}" class="btn btn-secondary">
                        ğŸ”„ é‡åšé”™é¢˜
                    </a>
                    {% endif %}
                </div>
            </div>
            margin-bottom: 15px;
        }
        
        .answer-box {
            padding: 12px;
            border-radius: 6px;
            border: 2px solid;
        }
        
        .correct-answer {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .wrong-answer {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .answer-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .stats-container {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .navigation-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            color: #007bff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background: #e9ecef;
            text-decoration: none;
        }
        
        @media (max-width: 768px) {
            .answer-comparison {
                grid-template-columns: 1fr;
            }
            
            .wrong-answer-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .navigation-bar {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="user-info-bar">
        <div>
            {% if username %}
                <span>æ¬¢è¿æ‚¨, <strong>{{ username }}</strong>!</span>
            {% else %}
                <span>æ¬¢è¿, è®¿å®¢!</span>
            {% endif %}
        </div>
        <div>
            {% if username %}
                <button id="logoutBtnGlobal">ç™»å‡º</button>
            {% endif %}
        </div>
    </div>

    <div class="container-box">
        <h1>ğŸ“š æˆ‘çš„é”™é¢˜æœ¬</h1>
        
        <div class="navigation-bar">
            <div class="nav-links">
                <a href="{{ url_for('quiz_page_actual') }}" class="nav-link">ğŸ  è¿”å›ç»ƒä¹ </a>
                {% if wrong_answers %}
                <a href="{{ url_for('retry_wrong_questions') }}" class="nav-link">ğŸ”„ é‡åšé”™é¢˜</a>
                {% endif %}
            </div>
            <div>
                <span class="question-meta">é”™é¢˜æœ¬ç®¡ç†</span>
            </div>
        </div>

        {% if stats %}
        <div class="stats-container">
            <h3>ğŸ“Š é”™é¢˜ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.total_wrong }}</div>
                    <div class="stat-label">æ€»é”™é¢˜æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ stats.uncorrected_wrong }}</div>
                    <div class="stat-label">æœªçº æ­£é”™é¢˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ stats.total_wrong - stats.uncorrected_wrong }}</div>
                    <div class="stat-label">å·²çº æ­£é”™é¢˜</div>
                </div>
                {% if stats.total_wrong > 0 %}
                <div class="stat-item">
                    <div class="stat-number">{{ "%.1f"|format((stats.total_wrong - stats.uncorrected_wrong) / stats.total_wrong * 100) }}%</div>
                    <div class="stat-label">çº æ­£ç‡</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if wrong_answers %}
            <h3>âŒ é”™é¢˜åˆ—è¡¨ ({{ wrong_answers|length }} é“)</h3>
            
            {% for wrong_answer in wrong_answers %}
            <div class="wrong-answer-item" data-question-id="{{ wrong_answer.question_id if wrong_answer.question_id else wrong_answer[2] }}">
                <div class="wrong-answer-header">
                    <div class="question-meta">
                        <strong>æ¥æº:</strong> {{ wrong_answer.source_doc if wrong_answer.source_doc else wrong_answer[8] }} |
                        <strong>ç±»å‹:</strong> 
                        {% set qtype = wrong_answer.question_type if wrong_answer.question_type else wrong_answer[4] %}
                        {% if qtype == 'single' %}å•é€‰é¢˜
                        {% elif qtype == 'multiple' %}å¤šé€‰é¢˜  
                        {% elif qtype == 'judgment_as_single' %}åˆ¤æ–­é¢˜
                        {% else %}{{ qtype }}
                        {% endif %} |
                        <strong>æœ€åé”™è¯¯æ—¶é—´:</strong> {{ wrong_answer.last_wrong_at if wrong_answer.last_wrong_at else wrong_answer[10] }}
                    </div>
                    <div class="wrong-count">
                        é”™è¯¯ {{ wrong_answer.wrong_count if wrong_answer.wrong_count else wrong_answer[9] }} æ¬¡
                    </div>
                </div>
                
                <div class="question-text">
                    {{ wrong_answer.question_text if wrong_answer.question_text else wrong_answer[3] }}
                </div>
                
                <div class="answer-comparison">
                    <div class="answer-box wrong-answer">
                        <div class="answer-label">âŒ ä½ çš„ç­”æ¡ˆ:</div>
                        <div>{{ wrong_answer.user_answer if wrong_answer.user_answer else wrong_answer[6] }}</div>
                    </div>
                    <div class="answer-box correct-answer">
                        <div class="answer-label">âœ… æ­£ç¡®ç­”æ¡ˆ:</div>
                        <div>{{ wrong_answer.correct_answer if wrong_answer.correct_answer else wrong_answer[5] }}</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success mark-corrected-btn" 
                            data-question-id="{{ wrong_answer.question_id if wrong_answer.question_id else wrong_answer[2] }}">
                        âœ“ æ ‡è®°ä¸ºå·²æŒæ¡
                    </button>
                    <button class="btn btn-primary show-options-btn" 
                            data-options="{{ wrong_answer.question_options if wrong_answer.question_options else wrong_answer[7] }}">
                        ğŸ‘ï¸ æŸ¥çœ‹é€‰é¡¹
                    </button>
                </div>
                
                <!-- é€‰é¡¹æ˜¾ç¤ºåŒºåŸŸï¼Œé»˜è®¤éšè— -->
                <div class="options-display" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <strong>é¢˜ç›®é€‰é¡¹:</strong>
                    <div class="options-content"></div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ‰</div>
                <h3>å¤ªæ£’äº†ï¼æ‚¨è¿˜æ²¡æœ‰é”™é¢˜</h3>
                <p>ç»§ç»­ä¿æŒï¼Œäº‰å–ä¸å‡ºç°åœ¨è¿™é‡Œå“¦ï¼</p>
                <a href="{{ url_for('quiz_page_actual') }}" class="btn btn-primary">å¼€å§‹ç»ƒä¹ </a>
            </div>
        {% endif %}
    </div>

    <script>
        const LOGOUT_API_URL = "{{ url_for('api_logout') }}";
        const MARK_CORRECTED_API_URL = "{{ url_for('mark_corrected') }}";
        
        // ç™»å‡ºåŠŸèƒ½
        const logoutButton = document.getElementById('logoutBtnGlobal');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    const response = await fetch(LOGOUT_API_URL, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (response.ok && result.redirect_url) {
                        window.location.href = result.redirect_url;
                    } else {
                        alert(result.message || 'ç™»å‡ºå¤±è´¥');
                    }
                } catch (error) {
                    console.error('ç™»å‡ºè¯·æ±‚å‡ºé”™:', error);
                    alert('ç™»å‡ºè¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
                }
            });
        }
        
        // æ ‡è®°ä¸ºå·²æŒæ¡åŠŸèƒ½
        document.querySelectorAll('.mark-corrected-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const questionId = this.dataset.questionId;
                
                if (!confirm('ç¡®å®šè¦æ ‡è®°è¿™é“é¢˜ä¸ºå·²æŒæ¡å—ï¼Ÿæ ‡è®°åå°†ä¸å†æ˜¾ç¤ºåœ¨é”™é¢˜æœ¬ä¸­ã€‚')) {
                    return;
                }
                
                try {
                    const response = await fetch(MARK_CORRECTED_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question_id: questionId })
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        // ç§»é™¤è¯¥é”™é¢˜é¡¹
                        const wrongAnswerItem = document.querySelector(`[data-question-id="${questionId}"]`);
                        wrongAnswerItem.style.transition = 'opacity 0.3s';
                        wrongAnswerItem.style.opacity = '0';
                        setTimeout(() => {
                            wrongAnswerItem.remove();
                            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™é¢˜
                            const remainingItems = document.querySelectorAll('.wrong-answer-item');
                            if (remainingItems.length === 0) {
                                location.reload(); // é‡æ–°åŠ è½½é¡µé¢æ˜¾ç¤ºç©ºçŠ¶æ€
                            }
                        }, 300);
                        alert(result.message);
                    } else {
                        alert(result.message || 'æ“ä½œå¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ ‡è®°çº æ­£å¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
                }
            });
        });
        
        // æŸ¥çœ‹é€‰é¡¹åŠŸèƒ½
        document.querySelectorAll('.show-options-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const optionsData = this.dataset.options;
                const optionsDisplay = this.closest('.wrong-answer-item').querySelector('.options-display');
                const optionsContent = optionsDisplay.querySelector('.options-content');
                
                if (optionsDisplay.style.display === 'none') {
                    try {
                        const options = JSON.parse(optionsData || '{}');
                        let optionsHtml = '';
                        
                        Object.entries(options).forEach(([key, value]) => {
                            optionsHtml += `<div style="margin: 5px 0;"><strong>${key}:</strong> ${value}</div>`;
                        });
                        
                        optionsContent.innerHTML = optionsHtml || 'æš‚æ— é€‰é¡¹æ•°æ®';
                        optionsDisplay.style.display = 'block';
                        this.textContent = 'ğŸ™ˆ éšè—é€‰é¡¹';
                    } catch (error) {
                        optionsContent.innerHTML = 'é€‰é¡¹æ•°æ®æ ¼å¼é”™è¯¯';
                        optionsDisplay.style.display = 'block';
                        this.textContent = 'ğŸ™ˆ éšè—é€‰é¡¹';
                    }
                } else {
                    optionsDisplay.style.display = 'none';
                    this.textContent = 'ğŸ‘ï¸ æŸ¥çœ‹é€‰é¡¹';
                }
            });
        });
    </script>
</body>
</html>
