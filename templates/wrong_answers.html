<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š æˆ‘çš„é”™é¢˜æœ¬ - æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-wrapper">
        <div class="user-info-bar">
            <div>
                {% if username %}
                    <span>æ¬¢è¿æ‚¨, <strong>{{ username }}</strong>! ğŸ“š</span>
                {% else %}
                    <span>æ¬¢è¿, è®¿å®¢! è¯·å…ˆ<a href="{{ url_for('login_page') }}" style="color: #60a5fa; text-decoration: underline;">ç™»å½•</a> ğŸ”</span>
                {% endif %}
            </div>
            <div>
                {% if username %}
                    <button id="logoutBtnGlobal" class="btn-danger">é€€å‡ºç™»å½•</button> 
                {% endif %}
            </div>
        </div>
        
        <div class="container-box wrong-answers-container">
            <h1>ğŸ“š æˆ‘çš„é”™é¢˜æœ¬</h1>
            <p class="subtitle">æ™ºèƒ½é”™é¢˜ç®¡ç†ï¼ŒåŠ©åŠ›é«˜æ•ˆå­¦ä¹ </p>
            
            <!-- å¯¼èˆªæ  -->
            <div class="navigation-bar">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <a href="{{ url_for('quiz_page_actual') }}" class="btn btn-outline">
                        ğŸ¯ è¿”å›ç»ƒä¹ 
                    </a>
                    {% if wrong_answers and wrong_answers|length > 0 %}
                    <a href="{{ url_for('retry_wrong_questions') }}" class="btn btn-secondary">
                        ğŸ”„ é‡åšé”™é¢˜
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä»ªè¡¨æ¿ -->
            {% if statistics %}
            <div class="stats-dashboard">
                <div class="stat-card danger">
                    <span class="stat-number">{{ statistics.total_wrong }}</span>
                    <div class="stat-label">ğŸ“ æ€»é”™é¢˜æ•°</div>
                </div>
                <div class="stat-card warning">
                    <span class="stat-number">{{ statistics.uncorrected_wrong }}</span>
                    <div class="stat-label">âŒ æœªçº æ­£é”™é¢˜</div>
                </div>
                <div class="stat-card success">
                    <span class="stat-number">{{ "%.1f"|format(statistics.correction_rate) }}%</span>
                    <div class="stat-label">âœ… çº æ­£ç‡</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">{{ statistics.total_wrong - statistics.uncorrected_wrong }}</span>
                    <div class="stat-label">ğŸ¯ å·²æŒæ¡é¢˜ç›®</div>
                </div>
            </div>
            {% endif %}

            <!-- é”™é¢˜åˆ—è¡¨ -->
            {% if wrong_answers and wrong_answers|length > 0 %}
                <div class="wrong-answers-list">
                    <h3>âŒ é”™é¢˜åˆ—è¡¨ ({{ wrong_answers|length }} é“)</h3>
                    
                    {% for wrong_answer in wrong_answers %}
                    <div class="wrong-answer-item{% if wrong_answer.is_corrected %} corrected{% endif %}" 
                         data-question-id="{{ wrong_answer.question_id }}">
                        
                        <div class="wrong-answer-header">
                            <div class="wrong-answer-meta">
                                <span class="meta-tag source-tag">
                                    ğŸ“„ {{ wrong_answer.source_doc }}
                                </span>
                                <span class="meta-tag error-count-tag">
                                    âŒ é”™è¯¯ {{ wrong_answer.wrong_count }} æ¬¡
                                </span>
                                <span class="meta-tag date-tag">
                                    ğŸ•’ {{ wrong_answer.last_wrong_at.strftime('%Y-%m-%d %H:%M') if wrong_answer.last_wrong_at else 'æœªçŸ¥æ—¶é—´' }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="wrong-question-text">
                            {{ wrong_answer.question_text }}
                        </div>
                        
                        <div class="answer-comparison">
                            <div class="answer-box user-answer">
                                <strong>âŒ ä½ çš„ç­”æ¡ˆ:</strong><br>
                                {{ wrong_answer.user_answer }}
                            </div>
                            <div class="answer-box correct-answer">
                                <strong>âœ… æ­£ç¡®ç­”æ¡ˆ:</strong><br>
                                {{ wrong_answer.correct_answer }}
                            </div>
                        </div>
                        
                        <div class="wrong-answer-actions">
                            {% if not wrong_answer.is_corrected %}
                            <button class="btn btn-secondary mark-corrected-btn" 
                                    data-question-id="{{ wrong_answer.question_id }}">
                                âœ… æ ‡è®°ä¸ºå·²æŒæ¡
                            </button>
                            {% else %}
                            <span class="btn btn-outline" disabled>
                                âœ“ å·²æŒæ¡
                            </span>
                            {% endif %}
                            
                            <button class="btn btn-outline show-options-btn" 
                                    data-options="{{ wrong_answer.question_options|tojson if wrong_answer.question_options else '{}' }}">
                                ğŸ‘ï¸ æŸ¥çœ‹é€‰é¡¹
                            </button>
                        </div>
                        
                        <!-- é€‰é¡¹æ˜¾ç¤ºåŒºåŸŸï¼Œé»˜è®¤éšè— -->
                        <div class="options-display" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                            <strong>ğŸ’¡ é¢˜ç›®é€‰é¡¹:</strong>
                            <div class="options-content"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‰</div>
                    <h3>å¤ªæ£’äº†ï¼æ‚¨è¿˜æ²¡æœ‰é”™é¢˜</h3>
                    <p>ç»§ç»­ä¿æŒä¼˜ç§€çš„å­¦ä¹ çŠ¶æ€ï¼Œäº‰å–ä¸å‡ºç°åœ¨è¿™é‡Œå“¦ï¼</p>
                    <a href="{{ url_for('quiz_page_actual') }}" class="btn btn-primary">
                        ğŸš€ å¼€å§‹ç»ƒä¹ 
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        const LOGOUT_API_URL = "{{ url_for('api_logout') }}";
        const MARK_CORRECTED_API_URL = "{{ url_for('mark_corrected') }}";
        
        // ç™»å‡ºåŠŸèƒ½
        const logoutButton = document.getElementById('logoutBtnGlobal');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    const response = await fetch(LOGOUT_API_URL, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (response.ok && result.redirect_url) {
                        window.location.href = result.redirect_url;
                    } else {
                        alert(result.message || 'ç™»å‡ºå¤±è´¥');
                    }
                } catch (error) {
                    console.error('ç™»å‡ºè¯·æ±‚å‡ºé”™:', error);
                    alert('ç™»å‡ºè¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
                }
            });
        }
        
        // æ ‡è®°ä¸ºå·²æŒæ¡åŠŸèƒ½
        document.querySelectorAll('.mark-corrected-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const questionId = this.dataset.questionId;
                
                if (!confirm('ç¡®å®šè¦æ ‡è®°è¿™é“é¢˜ä¸ºå·²æŒæ¡å—ï¼Ÿæ ‡è®°åå°†ä¸å†åœ¨é‡åšé”™é¢˜æ¨¡å¼ä¸­å‡ºç°ã€‚')) {
                    return;
                }
                
                try {
                    this.disabled = true;
                    this.textContent = 'â³ å¤„ç†ä¸­...';
                    
                    const response = await fetch(MARK_CORRECTED_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question_id: questionId })
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        // æ ‡è®°è¯¥é”™é¢˜é¡¹ä¸ºå·²çº æ­£
                        const wrongAnswerItem = this.closest('.wrong-answer-item');
                        wrongAnswerItem.classList.add('corrected');
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        this.outerHTML = '<span class="btn btn-outline" disabled>âœ“ å·²æŒæ¡</span>';
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        const feedback = document.createElement('div');
                        feedback.className = 'feedback correct';
                        feedback.textContent = 'âœ… ' + result.message;
                        feedback.style.marginTop = '1rem';
                        wrongAnswerItem.appendChild(feedback);
                        
                        setTimeout(() => feedback.remove(), 3000);
                        
                    } else {
                        this.disabled = false;
                        this.textContent = 'âœ… æ ‡è®°ä¸ºå·²æŒæ¡';
                        alert(result.message || 'æ“ä½œå¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ ‡è®°çº æ­£å¤±è´¥:', error);
                    this.disabled = false;
                    this.textContent = 'âœ… æ ‡è®°ä¸ºå·²æŒæ¡';
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
                }
            });
        });
        
        // æŸ¥çœ‹é€‰é¡¹åŠŸèƒ½
        document.querySelectorAll('.show-options-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const optionsData = this.dataset.options;
                const optionsDisplay = this.closest('.wrong-answer-item').querySelector('.options-display');
                const optionsContent = optionsDisplay.querySelector('.options-content');
                
                if (optionsDisplay.style.display === 'none') {
                    try {
                        const options = JSON.parse(optionsData || '{}');
                        let optionsHtml = '';
                        
                        if (Object.keys(options).length > 0) {
                            Object.entries(options).forEach(([key, value]) => {
                                optionsHtml += `<div style="margin: 8px 0; padding: 8px; background: var(--bg-primary); border-radius: var(--radius-sm); border-left: 3px solid var(--primary-color);"><strong>${key}:</strong> ${value}</div>`;
                            });
                        } else {
                            optionsHtml = '<div style="color: var(--text-muted); font-style: italic;">æš‚æ— é€‰é¡¹æ•°æ®</div>';
                        }
                        
                        optionsContent.innerHTML = optionsHtml;
                        optionsDisplay.style.display = 'block';
                        this.textContent = 'ğŸ™ˆ éšè—é€‰é¡¹';
                        this.classList.remove('btn-outline');
                        this.classList.add('btn-primary');
                    } catch (error) {
                        optionsContent.innerHTML = '<div style="color: var(--danger-color);">âŒ é€‰é¡¹æ•°æ®æ ¼å¼é”™è¯¯</div>';
                        optionsDisplay.style.display = 'block';
                        this.textContent = 'ğŸ™ˆ éšè—é€‰é¡¹';
                    }
                } else {
                    optionsDisplay.style.display = 'none';
                    this.textContent = 'ğŸ‘ï¸ æŸ¥çœ‹é€‰é¡¹';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline');
                }
            });
        });
        
        // é¡µé¢åŠ è½½åŠ¨ç”»
        document.addEventListener('DOMContentLoaded', function() {
            const items = document.querySelectorAll('.wrong-answer-item, .stat-card');
            items.forEach((item, index) => {
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    item.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>
